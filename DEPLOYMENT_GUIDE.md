# CRE Studio Backend - Ubuntu Server Deployment Guide

This guide provides step-by-step instructions for deploying the CRE Studio Backend Django application on Ubuntu server with Celery, Redis, SSL certificate, and proper static/media file serving.

## Prerequisites

- Ubuntu 20.04 LTS or later
- Root or sudo access to the server
- Domain name pointing to your server's IP address
- Basic knowledge of Linux command line

## Table of Contents

1. [Server Preparation](#server-preparation)
2. [Initial Setup](#initial-setup)
3. [Database Configuration](#database-configuration)
4. [Application Deployment](#application-deployment)
5. [Service Configuration](#service-configuration)
6. [SSL Certificate Setup](#ssl-certificate-setup)
7. [Static and Media Files](#static-and-media-files)
8. [Monitoring and Maintenance](#monitoring-and-maintenance)
9. [Troubleshooting](#troubleshooting)

## Server Preparation

### 1. Update System Packages

```bash
sudo apt update && sudo apt upgrade -y
```

### 2. Install Required System Packages

```bash
sudo apt install -y \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    postgresql \
    postgresql-contrib \
    nginx \
    redis-server \
    git \
    curl \
    wget \
    unzip \
    software-properties-common \
    certbot \
    python3-certbot-nginx \
    supervisor \
    htop \
    ufw \
    fail2ban
```

### 3. Configure Firewall

```bash
sudo ufw allow 'Nginx Full'
sudo ufw allow OpenSSH
sudo ufw --force enable
```

## Initial Setup

### 1. Create Project Directory

```bash
sudo mkdir -p /var/www/cre-studio-backend
sudo chown -R $USER:$USER /var/www/cre-studio-backend
```

### 2. Set Up GitHub Access for Private Repository

Since your repository is private, you need to set up authentication on the server.

#### **Option A: SSH Key Authentication (Recommended)**

**Step 1: Generate SSH Key on Server**
```bash
ssh-keygen -t ed25519 -C "your-email@example.com"
# Press Enter to accept default file location
# Optionally set a passphrase for extra security
```

**Step 2: Add SSH Key to SSH Agent**
```bash
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_ed25519
```

**Step 3: Copy Public Key**
```bash
cat ~/.ssh/id_ed25519.pub
```

**Step 4: Add Public Key to GitHub**
1. Go to GitHub.com → Settings → SSH and GPG keys
2. Click "New SSH key"
3. Paste the public key content
4. Give it a title (e.g., "Production Server")
5. Click "Add SSH key"

**Step 5: Test SSH Connection**
```bash
ssh -T git@github.com
# You should see: "Hi ibrahim77gh! You've successfully authenticated..."
```

#### **Option B: Personal Access Token (Alternative)**

**Step 1: Create Personal Access Token**
1. Go to GitHub.com → Settings → Developer settings → Personal access tokens → Tokens (classic)
2. Click "Generate new token (classic)"
3. Select scopes: `repo` (Full control of private repositories)
4. Copy the generated token

**Step 2: Clone with Token**
```bash
cd /var/www/cre_studio_backend
git clone https://your-token@github.com/ibrahim77gh/cre-studio-backend.git .
```

### 3. Clone Your Project

**Using SSH (Recommended):**
```bash
cd /var/www/cre-studio-backend
git clone git@github.com:ibrahim77gh/cre-studio-backend.git .
```

**Using HTTPS with Token:**
```bash
cd /var/www/cre-studio-backend
git clone https://your-token@github.com/ibrahim77gh/cre-studio-backend.git .
```

**Using SCP (Alternative):**
```bash
# From your local machine
scp -r . user@your-server-ip:/var/www/cre-studio-backend/
```

### 4. Run the Setup Script

**Option A: Run GitHub setup first (Recommended)**
```bash
chmod +x deployment/setup_github_access.sh
./deployment/setup_github_access.sh
```

**Option B: Run main setup directly**
```bash
chmod +x deployment/setup.sh
./deployment/setup.sh
```

**Note:** If you choose Option A, the main setup script will automatically clone your repository. If you choose Option B, make sure you've already set up GitHub access manually.

This script will:
- Install all dependencies
- Set up PostgreSQL database
- Create virtual environment
- Install Python packages
- Configure systemd services
- Set up Nginx
- Create necessary directories

## Database Configuration

### 1. PostgreSQL Setup

The setup script creates a PostgreSQL database and user. The credentials are saved in the `.env` file:

```bash
# Database credentials (automatically generated)
DATABASE_NAME=cre_studio_db
DATABASE_USER=cre_studio_user
DATABASE_PASSWORD=<auto-generated-password>
DATABASE_HOST=localhost
DATABASE_PORT=5432
```

### 2. Run Migrations

```bash
cd /var/www/cre_studio_backend
source venv/bin/activate
export DEBUG=False
python manage.py migrate
```

## Application Deployment

### 1. Environment Configuration

Edit the `.env` file with your actual values:

```bash
nano /var/www/cre_studio_backend/.env
```

Update the following varinano /etc/nginx/sites-available/cre_studio_backendables:
- `SECRET_KEY`: Generate a new secret key
- `EMAIL_HOST_USER`: Your Gmail address
- `EMAIL_HOST_PASSWORD`: Your Gmail app password
- `GOOGLE_CLIENT_ID`: Your Google OAuth client ID
- `GOOGLE_CLIENT_SECRET`: Your Google OAuth client secret
- `DOMAIN_NAME`: Your actual domain name

### 2. Collect Static Files

```bash
cd /var/www/cre_studio_backend
source venv/bin/activate
export DEBUG=False
python manage.py collectstatic --noinput
```

### 3. Create Superuser

```bash
python manage.py createsuperuser
```

## Service Configuration

### 1. Systemd Services

The following services are configured:

- **django.service**: Main Django application
- **celery.service**: Celery worker for background tasks
- **celerybeat.service**: Celery beat for scheduled tasks
- **redis.service**: Redis server for caching and message broker

### 2. Enable and Start Services

```bash
sudo systemctl daemon-reload
sudo systemctl enable django celery celerybeat redis-server
sudo systemctl start redis-server
sudo systemctl start django
sudo systemctl start celery
sudo systemctl start celerybeat
```

### 3. Check Service Status

```bash
sudo systemctl status django
sudo systemctl status celery
sudo systemctl status celerybeat
sudo systemctl status redis-server
```

## SSL Certificate Setup

### 1. Update Domain in Nginx Configuration

Before setting up SSL, update the domain name in the Nginx configuration:

```bash
sudo nano /etc/nginx/sites-available/cre_studio_backend
```

Replace `yourdomain.com` with your actual domain name.

### 2. Run SSL Setup Script

```bash
chmod +x deployment/ssl_setup.sh
./deployment/ssl_setup.sh yourdomain.com your-email@example.com
```

This script will:
- Update Nginx configuration with your domain
- Install SSL certificate using Let's Encrypt
- Set up automatic certificate renewal
- Configure HTTPS redirects

### 3. Verify SSL Certificate

```bash
sudo certbot certificates
```

## Static and Media Files

### 1. Static Files Configuration

Static files are served by Nginx directly for better performance:

- **Location**: `/var/www/cre_studio_backend/staticfiles/`
- **URL**: `https://yourdomain.com/static/`
- **Caching**: 1 year with immutable headers

### 2. Media Files Configuration

Media files are served by Nginx:

- **Location**: `/var/www/cre_studio_backend/media/`
- **URL**: `https://yourdomain.com/media/`
- **Caching**: 1 year with immutable headers

### 3. File Permissions

Ensure proper permissions for static and media files:

```bash
sudo chown -R www-data:www-data /var/www/cre_studio_backend/staticfiles
sudo chown -R www-data:www-data /var/www/cre_studio_backend/media
sudo chmod -R 755 /var/www/cre_studio_backend/staticfiles
sudo chmod -R 755 /var/www/cre_studio_backend/media
```

## Monitoring and Maintenance

### 1. Monitoring Script

Use the provided monitoring script to check system health:

```bash
chmod +x deployment/monitor.sh
./deployment/monitor.sh
```

### 2. Log Files

Monitor application logs:

```bash
# Django application logs
sudo tail -f /var/log/django/cre_studio_backend.log

# Gunicorn logs
sudo tail -f /var/log/gunicorn/error.log
sudo tail -f /var/log/gunicorn/access.log

# Nginx logs
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 3. Service Management

```bash
# Restart services
sudo systemctl restart django
sudo systemctl restart celery
sudo systemctl restart celerybeat
sudo systemctl restart nginx

# Check service status
sudo systemctl status django
sudo systemctl status celery
sudo systemctl status celerybeat
sudo systemctl status nginx
```

### 4. Database Backup

Create a backup script:

```bash
#!/bin/bash
# backup_db.sh
pg_dump -h localhost -U cre_studio_user -d cre_studio_db > /var/backups/cre_studio_backup_$(date +%Y%m%d_%H%M%S).sql
```

### 5. Application Updates

Use the deployment script for updates:

```bash
chmod +x deployment/deploy.sh
./deployment/deploy.sh
```

This script will:
- Pull latest changes from your private GitHub repository
- Install/update dependencies
- Run database migrations
- Collect static files
- Restart all services

### 6. Managing Private Repository Access

#### **Adding New Team Members**
If you need to give access to other developers:

1. **Add them to your GitHub repository:**
   - Go to your repository → Settings → Manage access
   - Click "Invite a collaborator"
   - Add their GitHub username

2. **They need to set up SSH access on the server:**
   ```bash
   # On the server, as the new user
   chmod +x deployment/setup_github_access.sh
   ./deployment/setup_github_access.sh
   ```

#### **Updating Repository Access**
If you need to revoke access or add new keys:

1. **Remove old SSH keys from GitHub:**
   - Go to GitHub.com → Settings → SSH and GPG keys
   - Delete the old key

2. **Add new SSH key:**
   - Follow the SSH setup steps again
   - Or use the setup script: `./deployment/setup_github_access.sh`

#### **Troubleshooting Repository Access**
If you get authentication errors:

```bash
# Test SSH connection
ssh -T git@github.com

# Check SSH agent
ssh-add -l

# Re-add key if needed
ssh-add ~/.ssh/id_ed25519
```

## Troubleshooting

### Common Issues

#### 1. Service Won't Start

Check service logs:
```bash
sudo journalctl -u django.service -f
sudo journalctl -u celery.service -f
```

#### 2. Database Connection Issues

Test database connection:
```bash
sudo -u postgres psql -c "SELECT 1;"
```

#### 3. Static Files Not Loading

Check file permissions and Nginx configuration:
```bash
sudo nginx -t
ls -la /var/www/cre_studio_backend/staticfiles/
```

#### 4. SSL Certificate Issues

Check certificate status:
```bash
sudo certbot certificates
sudo certbot renew --dry-run
```

#### 5. Celery Tasks Not Running

Check Celery logs:
```bash
sudo journalctl -u celery.service -f
```

### Performance Optimization

#### 1. Database Optimization

```bash
# Analyze database performance
sudo -u postgres psql -d cre_studio_db -c "SELECT * FROM pg_stat_activity;"
```

#### 2. Redis Monitoring

```bash
redis-cli info memory
redis-cli monitor
```

#### 3. Nginx Optimization

Monitor Nginx performance:
```bash
sudo nginx -T | grep worker_processes
```

## Security Considerations

### 1. Firewall Configuration

```bash
sudo ufw status
sudo ufw deny 22  # If you're not using SSH
```

### 2. Fail2Ban Configuration

```bash
sudo systemctl status fail2ban
sudo fail2ban-client status
```

### 3. Regular Updates

```bash
sudo apt update && sudo apt upgrade -y
```

### 4. Backup Strategy

- Database backups (daily)
- Application code backups (version control)
- Configuration file backups
- SSL certificate backups

## Production Checklist

- [ ] Server hardened and updated
- [ ] Firewall configured
- [ ] SSL certificate installed and auto-renewal enabled
- [ ] Database configured and secured
- [ ] All services running and enabled
- [ ] Static and media files properly served
- [ ] Monitoring and logging configured
- [ ] Backup strategy implemented
- [ ] Domain DNS configured
- [ ] Application tested and working

## Support

For issues or questions:

1. Check the logs first
2. Use the monitoring script
3. Verify service status
4. Check configuration files
5. Review this documentation

## Additional Resources

- [Django Deployment Checklist](https://docs.djangoproject.com/en/stable/howto/deployment/checklist/)
- [Nginx Configuration Guide](https://nginx.org/en/docs/)
- [Let's Encrypt Documentation](https://letsencrypt.org/docs/)
- [Celery Documentation](https://docs.celeryproject.org/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
